

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>luxpy.toolboxes.spdbuild.spdbuilder2020 &mdash; LuxPy 1.6.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> LuxPy
          

          
          </a>

          
            
            
              <div class="version">
                1.6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License: GPLv3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../required_packages.html">Imported (required) packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../luxpy_structure.html">Luxpy package structure</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">LuxPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>luxpy.toolboxes.spdbuild.spdbuilder2020</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for luxpy.toolboxes.spdbuild.spdbuilder2020</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for building and optimizing SPDs (2)</span>
<span class="sd">===========================================</span>

<span class="sd">This module differs from spdbuild.py in the spdoptimizer function,</span>
<span class="sd">that can use several different minimization algorithms, as well as a user defined</span>
<span class="sd">method. It is also written such that the user can easily write his own</span>
<span class="sd">primary constructor function. In contrast to spdbuild.py, it only supports the</span>
<span class="sd">&#39;3mixer&#39; algorithms for calculating the mixing contributions of the primaries.</span>

<span class="sd">Functions</span>
<span class="sd">---------</span>
<span class="sd"> :gaussian_prim_constructor: constructs a gaussian based primary set.</span>
<span class="sd"> </span>
<span class="sd"> :_setup_wlr: Setup the wavelength range for use in prim_constructor.</span>
<span class="sd"> </span>
<span class="sd"> :_extract_prim_optimization_parameters: Extact the primary parameters from the optimization vector x and the prim_constructor_parameter_defs dict.</span>

<span class="sd"> :_start_optimization_tri: Start optimization of _fitnessfcn for n primaries using the specified minimize_method. (see notes in docstring on specifications for the  user-defined minimization fcn) </span>
<span class="sd">   </span>
<span class="sd"> :spd_optimizer2(): Generate a spectrum with specified white point and optimized</span>
<span class="sd">                   for certain objective functions from a set of component </span>
<span class="sd">                   spectra or component spectrum model parameters.</span>
<span class="sd">                </span>
<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd"> 1. See examples below (in &#39;__main__&#39;) for use.</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">    1. `Ohno Y (2005). </span>
<span class="sd">    Spectral design considerations for white LED color rendering. </span>
<span class="sd">    Opt. Eng. 44, 111302. </span>
<span class="sd">    &lt;https://ws680.nist.gov/publication/get_pdf.cfm?pub_id=841839&gt;`_</span>

<span class="sd">.. codeauthor:: Kevin A.G. Smet (ksmet1977 at gmail.com)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">luxpy</span> <span class="kn">import</span> <span class="p">(</span><span class="n">math</span><span class="p">,</span> <span class="n">cri</span><span class="p">,</span> <span class="n">_WL3</span><span class="p">,</span> <span class="n">_CIEOBS</span><span class="p">,</span> <span class="n">getwlr</span><span class="p">,</span> <span class="n">SPD</span><span class="p">,</span> <span class="n">spd_to_power</span><span class="p">,</span>
                   <span class="n">spd_to_xyz</span><span class="p">,</span> <span class="n">xyz_to_Yxy</span><span class="p">,</span> <span class="n">colortf</span><span class="p">,</span> <span class="n">xyz_to_cct</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">luxpy.utils</span> <span class="kn">import</span> <span class="n">sp</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">plt</span><span class="p">,</span> <span class="n">_EPS</span><span class="p">,</span> <span class="n">np2d</span><span class="p">,</span> <span class="n">vec_to_dict</span>
<span class="kn">from</span> <span class="nn">luxpy.math.particleswarm</span> <span class="kn">import</span> <span class="n">particleswarm</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spd_optimizer2&#39;</span><span class="p">,</span><span class="s1">&#39;gaussian_prim_constructor&#39;</span><span class="p">,</span><span class="s1">&#39;gaussian_prim_parameter_types&#39;</span><span class="p">,</span>
           <span class="s1">&#39;_color3mixer&#39;</span><span class="p">,</span><span class="s1">&#39;_setup_wlr&#39;</span><span class="p">,</span><span class="s1">&#39;_extract_prim_optimization_parameters&#39;</span><span class="p">,</span>
           <span class="s1">&#39;_start_optimization_tri&#39;</span><span class="p">]</span>


<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="_color3mixer"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._color3mixer">[docs]</a><span class="k">def</span> <span class="nf">_color3mixer</span><span class="p">(</span><span class="n">Yxyt</span><span class="p">,</span><span class="n">Yxy1</span><span class="p">,</span><span class="n">Yxy2</span><span class="p">,</span><span class="n">Yxy3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate fluxes required to obtain a target chromaticity </span>
<span class="sd">    when (additively) mixing 3 light sources.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :Yxyt: </span>
<span class="sd">            | ndarray with target Yxy chromaticities.</span>
<span class="sd">        :Yxy1: </span>
<span class="sd">            | ndarray with Yxy chromaticities of light sources 1.</span>
<span class="sd">        :Yxy2:</span>
<span class="sd">            | ndarray with Yxy chromaticities of light sources 2.</span>
<span class="sd">        :Yxy3:</span>
<span class="sd">            | ndarray with Yxy chromaticities of light sources 3.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :M: </span>
<span class="sd">            | ndarray with fluxes.</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        Yxyt, Yxy1, ... can contain multiple rows, referring to single mixture.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">Yxy1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yxy1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yxy1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Y2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">Yxy2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yxy2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yxy2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Y3</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="n">Yxy3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yxy3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yxy3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Yt</span><span class="p">,</span> <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">Yxyt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yxyt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yxyt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">y1</span><span class="o">*</span><span class="p">((</span><span class="n">xt</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="n">y2</span><span class="o">-</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">y3</span><span class="p">)</span><span class="o">*</span><span class="n">x2</span><span class="o">+</span><span class="n">x3</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="n">xt</span><span class="o">*</span><span class="n">y3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">yt</span><span class="o">*</span><span class="p">((</span><span class="n">x3</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">y3</span><span class="o">+</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="o">-</span><span class="n">y2</span><span class="o">*</span><span class="p">((</span><span class="n">xt</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="n">y1</span><span class="o">-</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">y3</span><span class="p">)</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">x3</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="n">xt</span><span class="o">*</span><span class="n">y3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">yt</span><span class="o">*</span><span class="p">((</span><span class="n">x3</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">y3</span><span class="o">+</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">m3</span> <span class="o">=</span> <span class="n">y3</span><span class="o">*</span><span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">xt</span><span class="o">+</span><span class="n">x1</span><span class="o">*</span><span class="n">y2</span><span class="o">-</span><span class="n">x2</span><span class="o">*</span><span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">yt</span><span class="o">*</span><span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">y3</span><span class="o">-</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">x3</span><span class="o">+</span><span class="n">x1</span><span class="o">*</span><span class="n">y2</span><span class="o">-</span><span class="n">x2</span><span class="o">*</span><span class="n">y1</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">Yt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">m1</span><span class="o">/</span><span class="n">Y1</span><span class="p">,</span><span class="n">m2</span><span class="o">/</span><span class="n">Y2</span><span class="p">,</span><span class="n">m3</span><span class="o">/</span><span class="n">Y3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">M</span><span class="o">.</span><span class="n">T</span></div>

           
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># New triangle-based faster spectral optimizer:</span>
<span class="c1">#------------------------------------------------------------------------------    </span>
     
<span class="k">def</span> <span class="nf">_triangle_mixer</span><span class="p">(</span><span class="n">Yxy_target</span><span class="p">,</span> <span class="n">Yxyi</span><span class="p">,</span> <span class="n">triangle_strengths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the fluxes of each of the primaries to realize the target chromaticity Yxy_target given the triangle_strengths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate all possible 3-channel combinations (component triangles):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">Yxyi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">combos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">3</span><span class="p">)))</span> 
   
    <span class="c1"># calculate fluxes to obtain target Yxyt:</span>
    <span class="n">M3</span> <span class="o">=</span> <span class="n">_color3mixer</span><span class="p">(</span><span class="n">Yxy_target</span><span class="p">,</span><span class="n">Yxyi</span><span class="p">[</span><span class="n">combos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],:],</span><span class="n">Yxyi</span><span class="p">[</span><span class="n">combos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],:],</span><span class="n">Yxyi</span><span class="p">[</span><span class="n">combos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],:])</span>

    <span class="c1"># Get rid of out-of-gamut solutions:</span>
    <span class="n">is_out_of_gamut</span> <span class="o">=</span>  <span class="p">(((</span><span class="n">M3</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n_in_gamut</span> <span class="o">=</span> <span class="n">M3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">is_out_of_gamut</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">M3</span><span class="p">[</span><span class="n">is_out_of_gamut</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Nc</span> <span class="o">=</span> <span class="n">combos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="n">M3</span><span class="p">[</span><span class="n">is_out_of_gamut</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">Nc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_in_gamut</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Calulate fluxes of all components from M3 and x_final:            </span>
            <span class="n">M_final</span> <span class="o">=</span> <span class="n">triangle_strengths</span><span class="o">*</span><span class="n">M3</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">N</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">M_final</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combos</span> <span class="o">==</span> <span class="n">i</span><span class="p">)])</span>
            <span class="n">M</span> <span class="o">/=</span> <span class="n">n_in_gamut</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M3</span>
        
    <span class="k">return</span> <span class="n">M</span>

<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="_setup_wlr"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._setup_wlr">[docs]</a><span class="k">def</span> <span class="nf">_setup_wlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup the wavelength range for use in prim_constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">wlr</span> <span class="o">=</span> <span class="n">getwlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wlr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">wlr</span> <span class="o">=</span> <span class="n">wlr</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">wlr</span></div>

<div class="viewcode-block" id="_extract_prim_optimization_parameters"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._extract_prim_optimization_parameters">[docs]</a><span class="k">def</span> <span class="nf">_extract_prim_optimization_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> 
                                          <span class="n">prim_constructor_parameter_types</span><span class="p">,</span> 
                                          <span class="n">prim_constructor_parameter_defs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extact the primary parameters from the optimization vector x and the prim_constructor_parameter_defs dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">prim_constructor_parameter_types</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prim_constructor_parameter_defs</span><span class="p">:</span> <span class="c1"># extract value from x (to be optimized as not in _defs dict!)</span>
           <span class="n">pars</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[:,(</span><span class="n">ct</span><span class="o">*</span><span class="n">nprims</span><span class="p">):(</span><span class="n">ct</span><span class="o">*</span><span class="n">nprims</span><span class="p">)</span> <span class="o">+</span> <span class="n">nprims</span><span class="p">])</span>
           <span class="n">ct</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">pars</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prim_constructor_parameter_defs</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pars</span></div>
         
            

<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># Example code for a primiary constructor function:</span>
<span class="n">gaussian_prim_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="gaussian_prim_constructor"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.gaussian_prim_constructor">[docs]</a><span class="k">def</span> <span class="nf">gaussian_prim_constructor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">wlr</span><span class="p">,</span> 
                              <span class="n">prim_constructor_parameter_types</span><span class="p">,</span> 
                              <span class="o">**</span><span class="n">prim_constructor_parameter_defs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a set of nprim gaussian primaries with wavelengths wlr using the input in x and in kwargs.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :x:</span>
<span class="sd">            | ndarray (M x nprim) with optimization parameters.</span>
<span class="sd">        :nprim:</span>
<span class="sd">            | number of primaries</span>
<span class="sd">        :wlr:</span>
<span class="sd">            | wavelength range for which to construct a spectrum</span>
<span class="sd">        :prim_constructor:</span>
<span class="sd">            | function that constructs the primaries from the optimization parameters</span>
<span class="sd">            | Should have the form: </span>
<span class="sd">            |   prim_constructor(x, n, wl, prim_constructor_parameter_types, prim_constructor_parameter_defs)</span>
<span class="sd">        :prim_constructor_parameter_types:</span>
<span class="sd">            | gaussian_prim_parameter_types [&#39;peakwl&#39;, &#39;fwhm&#39;], optional</span>
<span class="sd">            | List with strings of the parameters used by prim_constructor() to</span>
<span class="sd">            | calculate the primary spd. All parameters listed and that do not</span>
<span class="sd">            | have default values (one for each prim!!!) in prim_constructor_parameters_defs </span>
<span class="sd">            | will be optimized.</span>
<span class="sd">        :prim_constructor_parameters_defs:</span>
<span class="sd">            | Dict with constructor parameters required by prim_constructor and/or </span>
<span class="sd">            | default values for parameters that are not being optimized.</span>
<span class="sd">            | For example: {&#39;fwhm&#39;:  [30]} will keep fwhm fixed and not optimize it.</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :spd:</span>
<span class="sd">            | ndarray with spectrum of nprim primaries (1st row = wavelengths)</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">    Example on how to create constructor:</span>
<span class="sd">        | ```def gaussian_prim_constructor(x, nprims, wlr,```</span>
<span class="sd">        | ```                     prim_constructor_parameter_types,``` </span>
<span class="sd">        | ```                     **prim_constructor_parameter_defs):```</span>
<span class="sd">        | ``` ```</span>
<span class="sd">        | ```    # Extract the primary parameters from x and prim_constructor_parameter_defs:```</span>
<span class="sd">        | ```    pars = _extract_prim_optimization_parameters(x, nprims, prim_constructor_parameter_types, prim_constructor_parameter_defs)```</span>
<span class="sd">        | ```    # setup wavelengths:```</span>
<span class="sd">        | ```    wlr = _setup_wlr(wlr)```</span>
<span class="sd">        | ``` ```</span>
<span class="sd">        | ```    # Collect parameters from pars dict:```</span>
<span class="sd">        | ```    fwhm_to_sig = 1/(2*(2*np.log(2))**0.5) # conversion factor for FWHM to sigma of Gaussian ```</span>
<span class="sd">        | ```    return np.vstack((wlr,np.exp(-0.5*((pars[&#39;peakwl&#39;]-wlr.T)/(pars[&#39;fwhm&#39;]*fwhm_to_sig))**2).T))```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract the primary parameters from x and prim_constructor_parameter_defs:</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">_extract_prim_optimization_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">prim_constructor_parameter_types</span><span class="p">,</span>
                                                 <span class="n">prim_constructor_parameter_defs</span><span class="p">)</span>
    <span class="c1"># setup wavelengths:</span>
    <span class="n">wlr</span> <span class="o">=</span> <span class="n">_setup_wlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
    
    <span class="c1"># Collect parameters from pars dict:</span>
    <span class="n">fwhm_to_sig</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># conversion factor for FWHM to sigma of Gaussian</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wlr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">wlr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fwhm_to_sig</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>  </div>

     
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_spd_constructor_tri</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Yxy_target</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cieobs</span><span class="o">=</span><span class="n">_CIEOBS</span><span class="p">,</span>
                       <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">gaussian_prim_constructor</span><span class="p">,</span>
                       <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="n">gaussian_prim_parameter_types</span><span class="p">,</span>
                       <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a mixture spectrum composed of n primaries using the 3mixer algorithm.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :x:</span>
<span class="sd">            | optimization parameters, first n!/(n-3)!*3! are the strengths of</span>
<span class="sd">            | the triangles in the &#39;3mixer&#39; algorithm.</span>
<span class="sd">        :Yxy_target:</span>
<span class="sd">            | Target chromaticity in Y,x,y coordinates.</span>
<span class="sd">        :n:</span>
<span class="sd">            | number of primaries</span>
<span class="sd">        :wlr:</span>
<span class="sd">            | [360,830,1],optional</span>
<span class="sd">            | wavelength range for which to construct a spectrum</span>
<span class="sd">        :cieobs:</span>
<span class="sd">            | _CIEOBS, optional</span>
<span class="sd">            | CIE CMFs to calculate chromaticity.</span>
<span class="sd">        :prims:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | If not None: use these pre-defined primary spectra</span>
<span class="sd">            | else construct primaries using the prim_constructor function</span>
<span class="sd">        :prim_constructor:</span>
<span class="sd">            | function that constructs the primaries from the optimization parameters</span>
<span class="sd">            | Should have the form: </span>
<span class="sd">            |   prim_constructor(x, n, wl, prim_constructor_parameter_types, **prim_constructor_parameter_defs)</span>
<span class="sd">        :prim_constructor_parameter_types:</span>
<span class="sd">            | gaussian_prim_parameter_types [&#39;peakwl&#39;, &#39;fwhm&#39;], optional</span>
<span class="sd">            | List with strings of the parameters used by prim_constructor() to</span>
<span class="sd">            | calculate the primary spd. All parameters listed and that do not</span>
<span class="sd">            | have default values (one for each prim!!!) in prim_constructor_parameters_defs </span>
<span class="sd">            | will be optimized.</span>
<span class="sd">        :prim_constructor_parameters_defs:</span>
<span class="sd">            | {}, optional</span>
<span class="sd">            | Dict with constructor parameters required by prim_constructor and/or </span>
<span class="sd">            | default values for parameters that are not being optimized.</span>
<span class="sd">            | For example: {&#39;fwhm&#39;:  30} will keep fwhm fixed and not optimize it.</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :spd, prims, M:</span>
<span class="sd">            | - spd: spectrum resulting from x</span>
<span class="sd">            | - spds: primary spds</span>
<span class="sd">            | - M: fluxes of all primaries</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        1. &#39;3mixer&#39; - optimization algorithm: The triangle/trio method creates </span>
<span class="sd">        for all possible combinations of 3 primary component spectra a spectrum</span>
<span class="sd">        that results in the target chromaticity using color3mixer() and then </span>
<span class="sd">        optimizes the weights of each of the latter spectra such that adding </span>
<span class="sd">        them (additive mixing) results in obj_vals as close as possible to </span>
<span class="sd">        the target values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># get primary spectra:</span>
    <span class="k">if</span> <span class="n">prims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_triangles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
        <span class="c1"># get triangle_strengths and remove them from x, remaining x are used to construct primaries:</span>
        <span class="n">triangle_strengths</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:</span><span class="n">n_triangles</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        
        <span class="n">prims</span> <span class="o">=</span> <span class="n">prim_constructor</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">n_triangles</span><span class="p">:],</span> <span class="n">n</span><span class="p">,</span> <span class="n">wlr</span><span class="p">,</span> 
                                 <span class="n">prim_constructor_parameter_types</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">prim_constructor_parameter_defs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">triangle_strengths</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span>
        <span class="n">wlr</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[:</span><span class="mi">1</span><span class="p">,:]</span>
    
    <span class="c1"># get primary chrom. coords.:</span>
    <span class="n">Yxyi</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">prims</span><span class="p">,</span><span class="n">tf</span><span class="o">=</span><span class="s1">&#39;spd&gt;Yxy&#39;</span><span class="p">,</span><span class="n">bwtf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cieobs&#39;</span><span class="p">:</span><span class="n">cieobs</span><span class="p">,</span><span class="s1">&#39;relative&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

    <span class="c1"># Get fluxes of each primary:</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">_triangle_mixer</span><span class="p">(</span><span class="n">Yxy_target</span><span class="p">,</span> <span class="n">Yxyi</span><span class="p">,</span> <span class="n">triangle_strengths</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Scale M to have target Y:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="o">*</span><span class="p">(</span><span class="n">Yxy_target</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">Yxyi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># Calculate optimized SPD:</span>
    <span class="n">spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">prims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">prims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>

    <span class="c1"># When all out-of-gamut: set spd to NaN&#39;s:</span>
    <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">return</span> <span class="n">spd</span><span class="p">,</span> <span class="n">prims</span><span class="p">,</span> <span class="n">M</span>


<span class="k">def</span> <span class="nf">_fitnessfcn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Yxy_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]]),</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">cieobs</span><span class="o">=</span><span class="n">_CIEOBS</span><span class="p">,</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">gaussian_prim_constructor</span><span class="p">,</span>
                <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="n">gaussian_prim_parameter_types</span><span class="p">,</span>
                <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="p">{},</span>
                <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">pareto</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">decimals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="n">obj_fcn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obj_fcn_pars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obj_fcn_weights</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                <span class="n">obj_tar_vals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Fitness function that calculates closeness of solution x to target values </span>
<span class="sd">    | for specified objective functions. See docstring of spd_optimizer2 for info</span>
<span class="sd">    | on the input parameters. If pareto is False than the Root-Sum-of-Squares of F</span>
<span class="sd">    | will be used as output during the optimization, else an F for each objective</span>
<span class="sd">    | functions is output, allowing multi-objective optimizer to work towards a</span>
<span class="sd">    | pareto optimal boundary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># setup parameters for use in loop(s):</span>
    <span class="n">maxF</span> <span class="o">=</span> <span class="mf">1e308</span>
    <span class="n">obj_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-16</span> <span class="c1">#avoid division by zero</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obj_fcn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">decimals</span> <span class="o">=</span> <span class="n">decimals</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_fcn</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        
        <span class="c1"># get spectrum for xi-parameters:</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>

        <span class="k">if</span> <span class="n">optimizer_type</span> <span class="o">==</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">:</span>
            <span class="n">spdi</span><span class="p">,</span> <span class="n">primsi</span><span class="p">,</span> <span class="n">Mi</span> <span class="o">=</span> <span class="n">_spd_constructor_tri</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">Yxy_target</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">wlr</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> 
                                                    <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">,</span> <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">prim_constructor</span><span class="p">,</span>
                                                    <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="n">prim_constructor_parameter_types</span><span class="p">,</span>
                                                    <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="n">prim_constructor_parameter_defs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only the &#39;3mixer&#39; optimizer type has been implemented so far (April 10, 2020)&quot;</span><span class="p">)</span>

        <span class="c1"># store output for all xi when not optimizing</span>
        <span class="k">if</span> <span class="n">out</span> <span class="o">!=</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">spds</span> <span class="o">=</span> <span class="n">spdi</span>
                <span class="n">Ms</span> <span class="o">=</span> <span class="n">Mi</span>
                <span class="n">primss</span> <span class="o">=</span> <span class="n">primsi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">spds</span><span class="p">,</span><span class="n">spdi</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]))</span>
                <span class="n">Ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ms</span><span class="p">,</span><span class="n">Mi</span><span class="p">))</span>
                <span class="n">primss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">primss</span><span class="p">,</span><span class="n">primsi</span><span class="p">))</span>
                
        <span class="c1"># create output string:</span>
        <span class="n">Yxy_est</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">spdi</span><span class="p">,</span><span class="n">tf</span><span class="o">=</span><span class="s1">&#39;spd&gt;Yxy&#39;</span><span class="p">,</span><span class="n">bwtf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cieobs&#39;</span><span class="p">:</span><span class="n">cieobs</span><span class="p">,</span><span class="s1">&#39;relative&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output_str</span> <span class="o">=</span> <span class="s1">&#39;spdi = </span><span class="si">{:1.0f}</span><span class="s1">/</span><span class="si">{:1.0f}</span><span class="s1">, chrom. = E(</span><span class="si">{:1.1f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">)/T(</span><span class="si">{:1.1f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">), &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Yxy_est</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Yxy_est</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">Yxy_est</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Yxy_target</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Yxy_target</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">Yxy_target</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>    

        <span class="c1"># calculate all objective functions:</span>
        <span class="k">if</span> <span class="n">obj_fcn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">F_i</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">obj_vals_i</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_fcn</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spdi</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    
                    <span class="c1"># Set normalization factor for F-calculation:</span>
                    <span class="n">obj_tar_vals_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj_tar_vals</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">obj_tar_vals_j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">f_normalize</span> <span class="o">=</span> <span class="n">obj_tar_vals_j</span>
                        <span class="n">f_normalize</span><span class="p">[</span><span class="n">f_normalize</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f_normalize</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="c1"># Calculate objective function j:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_fcn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span> <span class="c1"># one function for each objective:</span>
                        <span class="n">obj_vals_ij</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">obj_fcn</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">spdi</span><span class="p">,</span> <span class="o">**</span><span class="n">obj_fcn_pars</span><span class="p">[</span><span class="n">j</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># one function for multiple objectives for increased speed:</span>
                        <span class="n">obj_vals_ij</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">obj_fcn</span><span class="p">[</span><span class="n">j</span><span class="p">](</span><span class="n">spdi</span><span class="p">,</span> <span class="o">**</span><span class="n">obj_fcn_pars</span><span class="p">[</span><span class="n">j</span><span class="p">]))]</span>  

                    <span class="c1"># Store results in array:</span>
                    <span class="n">obj_vals_i</span> <span class="o">=</span> <span class="n">obj_vals_i</span> <span class="o">+</span> <span class="n">obj_vals_ij</span>
                    <span class="n">F_ij</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj_fcn_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj_vals_ij</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">decimals</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">-</span> <span class="n">obj_tar_vals_j</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">f_normalize</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">F_i</span> <span class="o">=</span> <span class="n">F_i</span> <span class="o">+</span> <span class="n">F_ij</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Take care of output when spd construction failed:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_fcn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_fcn</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
                        <span class="n">F_i</span> <span class="o">=</span> <span class="n">F_i</span> <span class="o">+</span> <span class="p">[</span><span class="n">maxF</span><span class="p">]</span><span class="o">*</span><span class="n">nn</span>
                        <span class="n">obj_vals_ij</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="n">nn</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">F_i</span> <span class="o">=</span> <span class="n">F_i</span> <span class="o">+</span> <span class="p">[</span><span class="n">maxF</span><span class="p">]</span>
                        <span class="n">obj_vals_ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>    
                    
                <span class="c1"># Create output string:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spdi</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_fcn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">output_str_sub</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span>
                        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_fcn</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">output_str_sub</span> <span class="o">=</span> <span class="n">output_str_sub</span> <span class="o">+</span> <span class="n">obj_fcn</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = </span><span class="si">{:1.2f}</span><span class="s1">, &#39;</span>
                        <span class="n">output_str_sub</span> <span class="o">=</span> <span class="n">output_str_sub</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                        <span class="n">output_str_sub</span> <span class="o">=</span> <span class="n">output_str_sub</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">obj_vals_ij</span><span class="p">))</span>    
                        <span class="n">output_str</span> <span class="o">=</span> <span class="n">output_str</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Fobj_#</span><span class="si">{:1.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = </span><span class="si">{:1.2f}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">output_str_sub</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                        <span class="n">output_str</span> <span class="o">=</span> <span class="n">output_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">F_ij</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;E</span><span class="si">{:1.2f}</span><span class="s1">(T</span><span class="si">{:1.2f}</span><span class="s1">), &#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_vals_ij</span><span class="p">)</span>
                        <span class="n">fmt_values</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_tar_vals</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">list</span><span class="p">)):</span> <span class="n">obj_tar_vals_j</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_tar_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> 
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_vals_ij</span><span class="p">)):</span>
                            <span class="n">fmt_values</span> <span class="o">=</span> <span class="n">fmt_values</span> <span class="o">+</span> <span class="p">[</span><span class="n">obj_vals_ij</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">obj_tar_vals_j</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                        <span class="n">output_str_ij</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">fmt_values</span><span class="p">)</span>
                        <span class="n">output_str</span> <span class="o">=</span> <span class="n">output_str</span> <span class="o">+</span> <span class="s1">&#39;obj</span><span class="si">{:1.0f}</span><span class="s1"> = &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">output_str_ij</span> 
        
        <span class="c1"># Set output F, obj_vals_i when no objective functions were supplied:</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F_i</span> <span class="o">=</span> <span class="p">((</span><span class="n">Yxy_est</span> <span class="o">-</span> <span class="n">Yxy_target</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># use distance to guide out-of-gamut solutions to in-gamut ones</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">F_i</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">F_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">F_i</span><span class="p">)</span><span class="o">*</span><span class="n">maxF</span>
            <span class="n">obj_vals_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Print output_str:</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output_str</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># Add F_i and obj_vals_i to list for output</span>
        <span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F_i</span><span class="p">)</span>
        <span class="n">obj_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj_vals_i</span><span class="p">)</span>
        
    
    <span class="c1"># Take Root-Sum-of-Squares of delta((val - tar)**2):</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pareto</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">obj_fcn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
         <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">F</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># return requested output:</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">F</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;spds,primss,Ms&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spds</span><span class="p">,</span> <span class="n">primss</span><span class="p">,</span> <span class="n">Ms</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>   

<span class="k">def</span> <span class="nf">_parse_bnds</span><span class="p">(</span><span class="n">bnds</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">min_</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e100</span><span class="p">,</span> <span class="n">max_</span> <span class="o">=</span> <span class="mf">1e100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup the lower- and upper-bounds for n primary mixtures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bnds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">min_</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">max_</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">min_</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">max_</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        
        <span class="n">lb</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_minimize_options_and_pareto</span><span class="p">(</span><span class="n">minimize_method</span><span class="p">,</span> <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set default options if not provided, as well as pareto (False: output Root-Sum-Squares of Fi in _fitnessfcn)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;particleswarm&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;ps&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;nelder-mead&#39;</span><span class="p">):</span>
        <span class="n">pareto</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span><span class="p">):</span>
        <span class="n">pareto</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># must be output per objective function!!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;pareto&#39;</span> <span class="ow">in</span> <span class="n">minimize_opts</span><span class="p">:</span>
            <span class="n">pareto</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">[</span><span class="s1">&#39;pareto&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pareto</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">minimize_opts</span> <span class="o">==</span> <span class="p">{}):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;particleswarm&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;ps&#39;</span><span class="p">):</span>
            <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;iters&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;n_particles&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                             <span class="s1">&#39;ps_opts&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">}}</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span><span class="p">):</span>
            <span class="n">minimize_opts</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">DEMO</span><span class="o">.</span><span class="n">init_options</span><span class="p">(</span><span class="n">display</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;nelder-mead&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xtol&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;maxfev&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">minimize_method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">minimize_opts</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;user-defined, specified as part of opt. function definition&#39;</span><span class="p">}</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;User already set the optimization options when defining the optimization function!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s1">&#39;Unsupported minimization method.&#39;</span><span class="p">)</span>      
    <span class="k">return</span> <span class="n">minimize_opts</span><span class="p">,</span> <span class="n">pareto</span>      

<div class="viewcode-block" id="_start_optimization_tri"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._start_optimization_tri">[docs]</a><span class="k">def</span> <span class="nf">_start_optimization_tri</span><span class="p">(</span><span class="n">_fitnessfcn</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fargs_dict</span><span class="p">,</span> <span class="n">bnds</span><span class="p">,</span> <span class="n">par_opt_types</span><span class="p">,</span>
                            <span class="n">minimize_method</span><span class="p">,</span> <span class="n">minimize_opts</span><span class="p">,</span> <span class="n">pareto</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;results&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start optimization of _fitnessfcn for n primaries using the specified minimize_method.</span>
<span class="sd">    </span>
<span class="sd">    Notes on minimize_method:</span>
<span class="sd">        1. Implemented: &#39;particleswarm&#39;, &#39;demo&#39;, &#39;nelder-mead&#39;</span>
<span class="sd">        2. if not isinstance(minimize_method, str): </span>
<span class="sd">            | then it should contain an optimizer funtion with the following interface: </span>
<span class="sd">            | results = minimize_method(fitnessfcn, Nparameters, args = {}, </span>
<span class="sd">            |                          bounds = (lb, ub), verbosity = 1)</span>
<span class="sd">            | With &#39;results&#39; a dictionary containing various variables related to the</span>
<span class="sd">            | optimization. It MUST contain a key &#39;x_final&#39; containing the final optimized parameters.</span>
<span class="sd">            | bnds must be [lowerbounds, upperbounds] with x-bounds ndarrays with values for each parameter.</span>
<span class="sd">            | args is an argument with a dictionary containing the values for the fitnessfcn. Pareto specifies</span>
<span class="sd">            | whether the output of the fitnessfcn should be the Root-Sum-of-Squares (True) of </span>
<span class="sd">            | all weighted objective function values or not (False). Individual function values are</span>
<span class="sd">            | required by true multi-objective optimizers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">n_triangle_strengths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">n_triangle_strengths</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_opt_types</span><span class="p">)</span><span class="o">*</span><span class="n">n</span> <span class="c1"># number of optimization parameters</span>
    <span class="n">fargs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">fargs_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span> 
    
    <span class="c1"># Particle swarm optimization:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;particleswarm&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;ps&#39;</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">particleswarm</span><span class="p">(</span><span class="n">_fitnessfcn</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">fargs_dict</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                                             <span class="n">iters</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">[</span><span class="s1">&#39;iters&#39;</span><span class="p">],</span>
                                             <span class="n">n_particles</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">[</span><span class="s1">&#39;n_particles&#39;</span><span class="p">],</span>
                                             <span class="n">ftol</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">[</span><span class="s1">&#39;ftol&#39;</span><span class="p">],</span>
                                             <span class="n">options</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">[</span><span class="s1">&#39;ps_opts&#39;</span><span class="p">],</span>
                                             <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
   
    <span class="c1"># Differential Evolutionary Multi-Objective Optimization:</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">xrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Must set bnds for the &#39;demo&#39; minimizer&quot;</span><span class="p">)</span>
        <span class="n">fopt</span><span class="p">,</span> <span class="n">xopt</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">DEMO</span><span class="o">.</span><span class="n">demo_opt</span><span class="p">(</span><span class="n">_fitnessfcn</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">fargs_list</span><span class="p">,</span> <span class="n">xrange</span> <span class="o">=</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_final&#39;</span><span class="p">:</span> <span class="n">xopt</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">fopt</span><span class="p">}</span>
    
    <span class="c1"># Local Simplex optimization using Nelder-Mead:</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">minimize_method</span> <span class="o">==</span> <span class="s1">&#39;nelder-mead&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bnds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">T</span> <span class="c1"># generate random start value within bounds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x0_triangle_strengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n_triangle_strengths</span><span class="p">))</span><span class="c1">#np.array([np.random.uniform(bnds[0,i+2*n], bnds[1,i+2*n],1) for i in range(n_triangle_strengths)]).T</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x0_triangle_strengths</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x0</span><span class="p">)))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">minimizebnd</span><span class="p">(</span><span class="n">_fitnessfcn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fargs_list</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="n">minimize_method</span><span class="p">,</span> <span class="n">use_bnd</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">)</span>
        <span class="n">x_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;x_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_final</span>
    
    <span class="c1"># Run user defined optimization algorithm:</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">minimize_method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">fargs_dict</span><span class="p">[</span><span class="s1">&#39;pareto&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pareto</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">minimize_method</span><span class="p">(</span><span class="n">_fitnessfcn</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">fargs_dict</span><span class="p">,</span> 
                                  <span class="n">bounds</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">minimize_opts</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s1">&#39;Unsupported minimization method.&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;results&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_default_prim_parameters</span><span class="p">(</span><span class="n">nprims</span><span class="p">,</span> <span class="n">parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get dict with default primary parameters, dict with parameter bounds and a list with parameters to be optimized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">parameter_to_be_optimized</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parameter_defaults</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameter_bnds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">parameter_types</span><span class="p">:</span>
        <span class="c1"># set up default parameter values (when not optimized):</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">parameter_to_be_optimized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdefs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pdefs</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdefs</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span> <span class="n">pdefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdefs</span><span class="p">]</span><span class="o">*</span><span class="n">nprims</span>
            <span class="n">parameter_defaults</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdefs</span>
        <span class="c1"># Create bnds for parameters to be optimized:</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">parameter_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameter_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">)</span>
            <span class="n">parameter_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_bnds</span><span class="p">(</span><span class="n">parameter_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">],</span> <span class="n">nprims</span><span class="p">)</span> <span class="c1"># parse temporary bnds to final ones</span>
    <span class="n">parameter_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># add remaining parameters to dict with defaults for unpacking in prim_constructor function</span>
    <span class="k">return</span> <span class="n">parameter_defaults</span><span class="p">,</span> <span class="n">parameter_bnds</span><span class="p">,</span> <span class="n">parameter_to_be_optimized</span>


<div class="viewcode-block" id="spd_optimizer2"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.spd_optimizer2">[docs]</a><span class="k">def</span> <span class="nf">spd_optimizer2</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                  <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">cieobs</span> <span class="o">=</span> <span class="n">_CIEOBS</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                  <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span>
                  <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">gaussian_prim_constructor</span><span class="p">,</span>
                  <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">],</span> 
                  <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="p">{},</span>
                  <span class="n">decimals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">obj_fcn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obj_fcn_pars</span> <span class="o">=</span> <span class="p">[{}],</span> 
                  <span class="n">obj_fcn_weights</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obj_tar_vals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">minimize_method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{},</span>
                  <span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Generate a spectrum with specified white point and optimized for certain objective </span>
<span class="sd">    | functions from a set of primary spectra or primary spectrum model parameters.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :target: </span>
<span class="sd">            | np2d([100,1/3,1/3]), optional</span>
<span class="sd">            | ndarray with Yxy chromaticity of target.</span>
<span class="sd">        :tar_type:</span>
<span class="sd">            | &#39;Yxy&#39; or str, optional</span>
<span class="sd">            | Specifies the input type in :target: (e.g. &#39;Yxy&#39; or &#39;cct&#39;)</span>
<span class="sd">        :cspace_bwtf:</span>
<span class="sd">            | {}, optional</span>
<span class="sd">            | Backward (cspace_to_xyz) transform parameters </span>
<span class="sd">            | (see colortf()) to go from :tar_type: to &#39;Yxy&#39;).</span>
<span class="sd">        :n:</span>
<span class="sd">            | 4, optional</span>
<span class="sd">            | Number of primaries in light mixture.</span>
<span class="sd">        :wl: </span>
<span class="sd">            | [360,830,1], optional</span>
<span class="sd">            | Wavelengths used in optimization when :prims: is not an</span>
<span class="sd">              ndarray with spectral data.</span>
<span class="sd">        :cieobs:</span>
<span class="sd">            | _CIEOBS, optional</span>
<span class="sd">            | CIE CMF set used to calculate chromaticity values, if not provided </span>
<span class="sd">            | in :Yxyi:.</span>
<span class="sd">        :optimizer_type:</span>
<span class="sd">            | &#39;3mixer&#39;,  optional</span>
<span class="sd">            | Specifies type of chromaticity optimization </span>
<span class="sd">            | For help on &#39;3mixer&#39; algorithm, see notes below.</span>
<span class="sd">        :prims:</span>
<span class="sd">            | ndarray of predefined primary spectra.</span>
<span class="sd">            | If None: they are built from optimization parameters using the </span>
<span class="sd">            | function in :prim_constructor:</span>
<span class="sd">        :prim_constructor:</span>
<span class="sd">            | function that constructs the primaries from the optimization parameters</span>
<span class="sd">            | Should have the form: </span>
<span class="sd">            |   ``prim_constructor(x, n, wl, prim_constructor_parameter_types, **prim_constructor_parameter_defs)``</span>
<span class="sd">        :prim_constructor_parameter_types:</span>
<span class="sd">            | gaussian_prim_parameter_types [&#39;peakwl&#39;, &#39;fwhm&#39;], optional</span>
<span class="sd">            | List with strings of the parameters used by prim_constructor() to</span>
<span class="sd">            | calculate the primary spd. All parameters listed and that do not</span>
<span class="sd">            | have default values (one for each prim!!!) in prim_constructor_parameters_defs </span>
<span class="sd">            | will be optimized.</span>
<span class="sd">        :prim_constructor_parameters_defs:</span>
<span class="sd">            | {}, optional</span>
<span class="sd">            | Dict with constructor parameters required by prim_constructor and/or </span>
<span class="sd">            | default values for parameters that are not being optimized.</span>
<span class="sd">            | For example: {&#39;fwhm&#39;:  30} will keep fwhm fixed and not optimize it.</span>
<span class="sd">        :decimals:</span>
<span class="sd">            | [5], optional</span>
<span class="sd">            | Rounding decimals of objective function values.</span>
<span class="sd">        :obj_fcn: </span>
<span class="sd">            | [None] or list, optional</span>
<span class="sd">            | Function handles to objective function.</span>
<span class="sd">        :obj_fcn_weights:</span>
<span class="sd">            | [1] or list, optional.</span>
<span class="sd">            | Weigths for each obj. fcn</span>
<span class="sd">        :obj_fcn_pars:</span>
<span class="sd">            | [None] or list, optional</span>
<span class="sd">            | Parameter dicts for each obj. fcn.</span>
<span class="sd">        :obj_tar_vals:</span>
<span class="sd">            | [0] or list, optional</span>
<span class="sd">            | Target values for each objective function.</span>
<span class="sd">        :minimize_method:</span>
<span class="sd">            | &#39;nelder-mead&#39;, optional</span>
<span class="sd">            | Optimization method used by minimize function.</span>
<span class="sd">            | options: </span>
<span class="sd">            |   - &#39;nelder-mead&#39;: Nelder-Mead simplex local optimization </span>
<span class="sd">            |                    using the luxpy.math.minimizebnd wrapper</span>
<span class="sd">            |                    with method set to &#39;Nelder-Mead&#39;.</span>
<span class="sd">            |   - &#39;particleswarm&#39;: Pseudo-global optimizer using particle swarms</span>
<span class="sd">            |                      (using wrapper luxpy.math.particleswarm)</span>
<span class="sd">            |   - &#39;demo&#39; :  Differential Evolutionary Multiobjective Optimizatizer</span>
<span class="sd">            |               (using math.DEMO.demo_opt)</span>
<span class="sd">            |   - A user-defined minimization function (see _start_optimization_tri? for </span>
<span class="sd">            |       info on the requirements of this function)</span>
<span class="sd">        :minimize_opts:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | Dict with minimization options. </span>
<span class="sd">            | None defaults to the options depending on choice of minimize_method</span>
<span class="sd">            |  - &#39;Nelder-Mead&#39;   : {&#39;xtol&#39;: 1e-5, &#39;disp&#39;: True, &#39;maxiter&#39;: 1000*Nc,</span>
<span class="sd">            |                       &#39;maxfev&#39; : 1000*Nc,&#39;fatol&#39;: 0.01}</span>
<span class="sd">            |  - &#39;particleswarm&#39; : {&#39;iters&#39;: 100, &#39;n_particles&#39;: 10, &#39;ftol&#39;: -np.inf,</span>
<span class="sd">            |                       &#39;ps_opts&#39; : {&#39;c1&#39;: 0.5, &#39;c2&#39;: 0.3, &#39;w&#39;:0.9}}</span>
<span class="sd">            |  - &#39;demo&#39; :          {&#39;F&#39;: 0.5, &#39;CR&#39;: 0.3, &#39;kmax&#39;: 300, &#39;mu&#39;: 100, &#39;display&#39;: True}</span>
<span class="sd">            |  - dict with options for user-defined minimization method.</span>
<span class="sd">        :triangle_strength_bnds:</span>
<span class="sd">            | (None,None)</span>
<span class="sd">            | Specifies lower- and upper-bounds for the strengths of each of the primary</span>
<span class="sd">            | combinations that will be made during the optimization using &#39;3mixer&#39;.</span>
<span class="sd">        :x0:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | If None: a random starting value will be generated for the Nelder-Mead</span>
<span class="sd">            | minimization algorithm, else the user defined starting value will be used.</span>
<span class="sd">            | Note that it should only contain a value for each peakwl and/or fwhm that</span>
<span class="sd">            | is set to be optimized. The triangle_strengths are added automatically.</span>
<span class="sd">        :verbosity:</span>
<span class="sd">            | 0, optional</span>
<span class="sd">            | If &gt; 0: print intermediate results.</span>
<span class="sd">        :out:</span>
<span class="sd">            | &#39;spds,primss,Ms,results&#39;, optional</span>
<span class="sd">            | Determines output of function (see :returns:).</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: </span>
<span class="sd">            | spds, primss,Ms,results</span>
<span class="sd">            | - &#39;spds&#39;: optimized spectrum (or spectra: for particleswarm and demo minimization methods)</span>
<span class="sd">            | - &#39;primss&#39;: primary spectra of each optimized spectrum</span>
<span class="sd">            | - &#39;Ms&#39; : ndarrays with fluxes of each primary</span>
<span class="sd">            | - &#39;results&#39;: dict with optimization results</span>

<span class="sd">    Notes on the optimization algorithms:</span>
<span class="sd">        </span>
<span class="sd">        1. &#39;3mixer&#39;: The triangle/trio method creates for all possible </span>
<span class="sd">        combinations of 3 primary component spectra a spectrum that results in </span>
<span class="sd">        the target chromaticity using color3mixer() and then optimizes the </span>
<span class="sd">        weights of each of the latter spectra such that adding them </span>
<span class="sd">        (additive mixing) results in obj_vals as close as possible to the </span>
<span class="sd">        target values.</span>
<span class="sd">       </span>
<span class="sd">        2. &#39;2mixer&#39;: APRIL 2020, NOT YET IMPLEMENTED!!</span>
<span class="sd">        Pairs (odd,even) of components are selected and combined using </span>
<span class="sd">        &#39;pair_strength&#39;. This process is continued until only 3 (combined)</span>
<span class="sd">        intermediate sources remain. Color3mixer is then used to calculate </span>
<span class="sd">        the fluxes for the remaining 3 sources, after which the fluxes of </span>
<span class="sd">        all components are back-calculated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">minimize_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">minimize_method</span> <span class="o">=</span> <span class="s1">&#39;Nelder-Mead&#39;</span>
    
    <span class="c1"># get wavelengths:</span>
    <span class="n">wlr</span> <span class="o">=</span> <span class="n">getwlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
    
    <span class="c1"># convert whatever Yxy_target to actual Yxy values:</span>
    <span class="n">Yxy_target</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tf</span> <span class="o">=</span> <span class="n">tar_type</span><span class="o">+</span><span class="s1">&#39;&gt;Yxy&#39;</span><span class="p">,</span> <span class="n">bwtf</span> <span class="o">=</span> <span class="n">cspace_bwtf</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;cieobs&#39;</span> <span class="ow">in</span> <span class="n">cspace_bwtf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cspace_bwtf</span><span class="p">[</span><span class="s1">&#39;cieobs&#39;</span><span class="p">]</span>
    

    <span class="c1"># set up default prim parameters and bounds (p_d: default pars, p_b: bounds, p_o: to be optimized):</span>
    <span class="n">par_def</span><span class="p">,</span><span class="n">par_bnds</span><span class="p">,</span><span class="n">par_opt_types</span> <span class="o">=</span> <span class="n">_get_default_prim_parameters</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">parameter_types</span> <span class="o">=</span> <span class="n">prim_constructor_parameter_types</span><span class="p">,</span>
                                                                  <span class="o">**</span><span class="n">prim_constructor_parameter_defs</span><span class="p">)</span>

    <span class="c1"># setup triangle bounds and attach the other bounds at the end:</span>
    <span class="n">n_triangle_strengths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
    <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="n">_parse_bnds</span><span class="p">(</span><span class="n">triangle_strengths_bnds</span><span class="p">,</span> <span class="n">n_triangle_strengths</span><span class="p">,</span> <span class="n">min_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bnds</span> <span class="o">=</span> <span class="n">triangle_strengths_bnds</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">par_bnds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">bnds</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="c1"># set default options if not provided:</span>
    <span class="n">minimize_opts</span><span class="p">,</span> <span class="n">pareto</span> <span class="o">=</span> <span class="n">_get_minimize_options_and_pareto</span><span class="p">(</span><span class="n">minimize_method</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>  
                                                          <span class="n">minimize_opts</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">)</span>
    
    <span class="c1"># Create inputs for fit_fcn:    </span>
    <span class="n">fargs_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Yxy_target&#39;</span><span class="p">:</span><span class="n">Yxy_target</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;wlr&#39;</span><span class="p">:</span><span class="n">wlr</span><span class="p">,</span> <span class="s1">&#39;cieobs&#39;</span><span class="p">:</span><span class="n">cieobs</span><span class="p">,</span>
                  <span class="s1">&#39;prims&#39;</span><span class="p">:</span><span class="n">prims</span><span class="p">,</span> <span class="s1">&#39;prim_constructor&#39;</span><span class="p">:</span><span class="n">prim_constructor</span><span class="p">,</span>
                  <span class="s1">&#39;prim_constructor_parameter_types&#39;</span><span class="p">:</span><span class="n">prim_constructor_parameter_types</span><span class="p">,</span>
                  <span class="s1">&#39;prim_constructor_parameter_defs&#39;</span><span class="p">:</span><span class="n">prim_constructor_parameter_defs</span><span class="p">,</span>
                  <span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;pareto&#39;</span><span class="p">:</span><span class="n">pareto</span><span class="p">,</span> <span class="s1">&#39;decimals&#39;</span><span class="p">:</span><span class="n">decimals</span><span class="p">,</span> <span class="s1">&#39;obj_fcn&#39;</span><span class="p">:</span><span class="n">obj_fcn</span><span class="p">,</span>
                  <span class="s1">&#39;obj_fcn_pars&#39;</span><span class="p">:</span><span class="n">obj_fcn_pars</span><span class="p">,</span><span class="s1">&#39;obj_fcn_weights&#39;</span><span class="p">:</span><span class="n">obj_fcn_weights</span><span class="p">,</span>
                  <span class="s1">&#39;obj_tar_vals&#39;</span><span class="p">:</span><span class="n">obj_tar_vals</span><span class="p">,</span><span class="s1">&#39;optimizer_type&#39;</span><span class="p">:</span><span class="n">optimizer_type</span><span class="p">,</span>
                  <span class="s1">&#39;verbosity&#39;</span><span class="p">:</span><span class="n">verbosity</span><span class="p">}</span>   
    
    <span class="c1"># Perform optimzation:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">_start_optimization_tri</span><span class="p">(</span><span class="n">_fitnessfcn</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fargs_dict</span><span class="p">,</span> <span class="n">bnds</span><span class="p">,</span> <span class="n">par_opt_types</span><span class="p">,</span>
                                        <span class="n">minimize_method</span><span class="p">,</span> <span class="n">minimize_opts</span><span class="p">,</span> <span class="n">pareto</span> <span class="o">=</span> <span class="n">pareto</span><span class="p">,</span> 
                                        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;results&#39;</span><span class="p">)</span>
    
    <span class="n">x_final</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;x_final&#39;</span><span class="p">]</span>
    <span class="n">fargs_dict</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms&#39;</span>
    <span class="n">spds</span><span class="p">,</span><span class="n">primss</span><span class="p">,</span><span class="n">Ms</span> <span class="o">=</span> <span class="n">_fitnessfcn</span><span class="p">(</span><span class="n">x_final</span><span class="p">,</span> <span class="o">**</span><span class="n">fargs_dict</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;spds,primss,Ms,x_final,results&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spds</span><span class="p">,</span> <span class="n">primss</span><span class="p">,</span> <span class="n">Ms</span><span class="p">,</span> <span class="n">x_final</span><span class="p">,</span> <span class="n">results</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

        
        
                
      
 <span class="c1">#------------------------------------------------------------------------------</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>    

    <span class="n">run_example_1</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># use pre-defined minimization methods</span>

    <span class="n">run_example_2</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># use user-defined  minimization method   </span>
    
    <span class="kn">import</span> <span class="nn">luxpy</span> <span class="k">as</span> <span class="nn">lx</span>
    <span class="n">cieobs</span> <span class="o">=</span> <span class="s1">&#39;1964_10&#39;</span>
    
    <span class="c1"># Set number of primaries and target chromaticity:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">200</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]])</span> 
    
    <span class="c1"># define function that calculates several objectives at the same time (for speed):</span>
    <span class="k">def</span> <span class="nf">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">):</span>
        <span class="n">Rf</span><span class="p">,</span><span class="n">Rg</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">cri</span><span class="o">.</span><span class="n">spd_to_cri</span><span class="p">(</span><span class="n">spd</span><span class="p">,</span> <span class="n">cri_type</span><span class="o">=</span><span class="s1">&#39;ies-tm30&#39;</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;Rf,Rg&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span><span class="p">))</span> 
    
    
    <span class="c1">#------------------------------------------------------------------------------</span>
    <span class="c1"># Example using a pre-defined minimization method:</span>

    <span class="k">if</span> <span class="n">run_example_1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># start optimization:</span>
        <span class="n">spd</span><span class="p">,</span> <span class="n">prims</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">spd_optimizer2</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                                      <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms&#39;</span><span class="p">,</span> 
                                      <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">gaussian_prim_constructor</span><span class="p">,</span>
                                      <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">],</span> 
                                      <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                                                         <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]},</span>
                                      <span class="n">obj_fcn</span> <span class="o">=</span> <span class="p">[(</span><span class="n">spd_to_cris</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> 
                                      <span class="n">obj_fcn_pars</span> <span class="o">=</span> <span class="p">[{}],</span> 
                                      <span class="n">obj_fcn_weights</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)],</span> <span class="n">obj_tar_vals</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)],</span>
                                      <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">minimize_method</span> <span class="o">=</span> <span class="s1">&#39;nelder-mead&#39;</span><span class="p">,</span>
                                      <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{},</span>
                                      <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>


    <span class="c1">#------------------------------------------------------------------------------</span>
    <span class="c1"># Example using a user-defined minimization method and a user-defined primary constructor:</span>

    <span class="k">if</span> <span class="n">run_example_2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                
        
        <span class="k">def</span> <span class="nf">user_prim_constructor2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">wlr</span><span class="p">,</span> 
                              <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span><span class="s1">&#39;spectral_width&#39;</span><span class="p">],</span> 
                              <span class="o">**</span><span class="n">prim_constructor_parameter_defs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            User defined prim constructor: lorenztian 2e order profile.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Extract the primary parameters from x and prim_constructor_parameter_defs:</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">_extract_prim_optimization_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">prim_constructor_parameter_types</span><span class="p">,</span>
                                                         <span class="n">prim_constructor_parameter_defs</span><span class="p">)</span>
            <span class="c1"># setup wavelengths:</span>
            <span class="n">wlr</span> <span class="o">=</span> <span class="n">_setup_wlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
            
            <span class="c1"># Collect parameters from pars dict:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># to ensure correct fwhm</span>
            <span class="n">spd</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">wlr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;spectral_width&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wlr</span><span class="p">,</span> <span class="n">spd</span><span class="p">))</span>
        
        
        <span class="c1"># Create a minimization function with the specified interface:</span>
        <span class="k">def</span> <span class="nf">user_minim2</span><span class="p">(</span><span class="n">fitnessfcn</span><span class="p">,</span> <span class="n">Nparameters</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">minimize_opts</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">particleswarm</span><span class="p">(</span><span class="n">fitnessfcn</span><span class="p">,</span> <span class="n">Nparameters</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span> 
                                         <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span> 
                                         <span class="n">iters</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">n_particles</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ftol</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                                         <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">},</span>
                                         <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
            <span class="c1"># Note that there is already a key &#39;x_final&#39; in results</span>
            <span class="k">return</span> <span class="n">results</span>
        
        
        <span class="c1"># start optimization:</span>
        <span class="n">spd</span><span class="p">,</span> <span class="n">prims</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">spd_optimizer2</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                                      <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms&#39;</span><span class="p">,</span> 
                                      <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">user_prim_constructor2</span><span class="p">,</span>
                                      <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;spectral_width&#39;</span><span class="p">],</span> 
                                      <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                                                         <span class="s1">&#39;spectral_width_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]},</span>
                                      <span class="n">obj_fcn</span> <span class="o">=</span> <span class="p">[(</span><span class="n">spd_to_cris</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> 
                                      <span class="n">obj_fcn_pars</span> <span class="o">=</span> <span class="p">[{}],</span> 
                                      <span class="n">obj_fcn_weights</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)],</span> <span class="n">obj_tar_vals</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)],</span>
                                      <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">minimize_method</span> <span class="o">=</span> <span class="n">user_minim2</span><span class="p">,</span>
                                      <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pareto&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">},</span>
                                      <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>
    
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Kevin A.G. Smet

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>